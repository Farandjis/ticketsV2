<?php
/**
 * Principe :
 *      R√©pond √† la demande de l'utilisateur.
 *      Il lui envoi des informations suppl√©mentaires concernant le ticket demand√© pour la page Mon Espace.
 *

 */

require(dirname(__FILE__) . "/../../ressources/fonctions/PHPfunctions.php");
$connexionUtilisateur = pageAccess(array('Administrateur Syst√®me')); // Renvoi vers e403 si la personne n'a pas acc√®s


session_start();

if ((isset($_SESSION['logadm'], $_SESSION['mdpadm'])) and $_SESSION['logadm'] == "administration_tix"){
    $cmd = shell_exec("echo '".htmlspecialchars($_SESSION['mdpadm'])."' | su administration_tix -c 'echo \"Acc√®s √† la page Mod√©ration de TIX [COOKIE].\"'");
    if ($cmd == null){ header('Location: ../authentification/action_deconnexion.php'); return;} // Si on a PAS r√©ussit √† se connecter, on d√©connecte l'admin sys (car piratage)
} else { header('Location: ../authentification/action_deconnexion.php'); return;}


$logadm = "administration_tix";
$mdpadm = $_SESSION['mdpadm'];
// On change d'utilisateur Linux. On passe d'Apache √† celui indiqu√©
$debutcmdADM = "echo '$mdpadm' | su $logadm -c 'echo \"$mdpadm\" | sudo -S "; // Ne pas oublier le ' √† la fin de la commande.



$recup = file_get_contents("php://input"); // On r√©cup√®re le fichier re√ßus (ici notre liste)
$headers = getallheaders();

if (! array_key_exists("Content-Type", $headers)){ // Cas o√π on acc√®de √† la page sans passer par le formulaire (donc "Content-Type" n'existe pas)
    header("Location: ../../erreurs/403.html");
    return;
}



try {
    if ($headers["Content-Type"] == "application/json") { // Si le fichier re√ßu est bien de type JSON (?)
        $_POST = ["ok"]; // ???
        $data = json_decode($recup, true);

        if (json_last_error() == JSON_ERROR_NONE) { // ???
            if (isset($data['maListe'])) {
                $maListe = $data['maListe']; // On r√©cup√®re notre liste (cr√©er en JavaScript, utilisable en PHP)
                $prison = $maListe[0]; // On r√©cup√®re le nom de la prison
                $typeFormulaire = $maListe[1]; // Le nom du formulaire dont on re√ßois la demande

                $dicoDesInfosSupplementaires = array($prison, $typeFormulaire);

                $output = shell_exec($debutcmdADM . 'fail2ban-client status | grep "Jail list" | sed -E "s/^[^:]+:[ \t]+//" | sed "s/,//g" | grep -o "TIX[^ ]*"\'');
                $prisons = explode("\n", trim($output));

                // On s'assure que la prison existe bien et peut √™tre manipuler
                if (in_array($prison, $prisons)) {

                    // Si formulaire "prison"
                    if ($typeFormulaire == "prisonForm") {
                        // trim permet de retirer le caract√®re de retour √† la ligne
                        $prisonMaxTentatives = trim(shell_exec($debutcmdADM . "fail2ban-client get $prison maxretry'"));
                        $prisonTempsBan = trim(shell_exec($debutcmdADM . "fail2ban-client get $prison bantime'"));
                        $prisonTempsAvOublie = trim(shell_exec($debutcmdADM . "fail2ban-client get $prison findtime'"));

                        header('Content-Type: application/json');
                        echo json_encode(array($prisonMaxTentatives, $prisonTempsAvOublie, $prisonTempsBan));
                        return;

                    } // Si formulaire "prison2"
                    elseif ($typeFormulaire == "prisonForm2") {
                        // On r√©cup√®re les informations sur tous les bannis de la prison
                        // $cmd = shell_exec($debutcmdADM . "fail2ban-client status $prison | grep -E \"IP_ADDRESS|Banned Since|Failures\"'");
                        $cmd = shell_exec($debutcmdADM . "fail2ban-client status $prison | grep -E \"Banned IP list\"  | sed \"s/.*: *//\" | sed \"s/^[ \\t]*//\"'");
                        // On r√©organise les donn√©es en tableau
                        $lesBannis = explode(" ", trim($cmd));

                        // A TERMINER üî¥üî¥üî¥üî¥üî¥

                        header('Content-Type: application/json');
                        echo json_encode($lesBannis);
                        return;
                    }

                    header('Content-Type: application/json');
                    echo json_encode($dicoDesInfosSupplementaires);
                    return;
                }




            }
        }
    }
}catch(Exception $e){
    header('Content-Type: application/json');
    $dicoDesInfosSupplementaires = array("Oups... " => "Impossible de charger des informations suppl√©mentaires.");
    echo json_encode($dicoDesInfosSupplementaires);
    return;
}
